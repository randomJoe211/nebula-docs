# Nebula Graph CRUD

This topic describes the basic CRUD operations in Nebula Graph.

## Graph space and Nebula Graph schema

A Nebula Graph instance consists of one or more graph spaces. Graph spaces are physically isolated from each other.  You can use different graph spaces in the same instance to store different data sets.

[Nebula Graph and graph spaces.png]

Before storing data into a  graph space, you have to define the database schema. Nebula Graph schema is based on the following components.

[Nebula Graph schema components.png]

| Schema component | Description                                                                             |
| ---------------- | --------------------------------------------------------------------------------------- |
| Vertex           | Represents an entity in the real world.                                                 |
| Tag              | The type of vertex. It defines a group of properties that describes a type of vertices. |
| Edge             | Represents a directed relationship between two vertices.                                |
| Edge type        | The type of edge. It defines a group of properties that describes a type of edges.      |

For more information, see [Nebula Graph schema](TODO) [TODO].

In this topic, we use the following data set to demonstrate basic CRUD operations.

[NBA data set.png]

## Check the machine status in the cluster

First of all, we recommend that you check the machine status in the Nebula Graph status to make sure all the storage servers (storaged) are connected to the metadata servers (metad). Run `SHOW HOSTS` as follows.

```nGQL
(root@nebula) [(none)]> SHOW HOSTS;
+-----------+-------+--------+--------------+---------------------+------------------------+
| Host      | Port  | Status | Leader count | Leader distribution | Partition distribution |
+-----------+-------+--------+--------------+---------------------+------------------------+
| storaged0 | 44500 | ONLINE | 0            | No valid partition  | No valid partition     |
+-----------+-------+--------+--------------+---------------------+------------------------+
| storaged1 | 44500 | ONLINE | 0            | No valid partition  | No valid partition     |
+-----------+-------+--------+--------------+---------------------+------------------------+
| storaged2 | 44500 | ONLINE | 0            | No valid partition  | No valid partition     |
+-----------+-------+--------+--------------+---------------------+------------------------+
Got 3 rows (time spent 1775/2334 us)
```

From the **Status** column of the table in the return message, we can see that all the storage servers are all online.

## Create and use a graph space

### nGQL Syntax

* Create a graph space:

    ```nGQL
    CREATE SPACE <graph space name>(partition_num=<partition number>, replica_factor=<replica number>);
    ```

    | Property       | Description                                                                                                                                                                                                                           |
    | -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
    | partition_num  | Specifies the number of partitions in each replica. The suggested number is the number of hard disks in the cluster times 5. For example, if you have 3 hard disks in the cluster, we recommend that you set 15 partitions.           |
    | replica_factor | Specifies the number of replicas in the Nebula Graph cluster. The suggested number is 3 in a production environment, and 1 in a test environment. The replica number must always be an odd number for the need of consistence voting. |

* Check for graph spaces:

    ```nGQL
    SHOW SPACES
    ```

* Use a graph space:

    ```nGQL
    USE <graph space name>
    ```

### Demonstration

1. Use the following statement to create a graph space named `nba`.

    ```nGQL
    (root@nebula) [(none)]> CREATE SPACE nba(partition_num=15, replica_factor=1);
    Execution succeeded (time spent 2817/3280 us)
    ```

2. Check the partition distribution with `SHOW HOSTS` to make sure the partitions are distributed in a balanced way.

    ```nGQL
    (root@nebula) [(none)]> SHOW HOSTS;
    +-----------+-------+--------+--------------+---------------------+------------------------+
    | Host      | Port  | Status | Leader count | Leader distribution | Partition distribution |
    +-----------+-------+--------+--------------+---------------------+------------------------+
    | storaged0 | 44500 | ONLINE | 1            | nba:5               | nba:5                  |
    +-----------+-------+--------+--------------+---------------------+------------------------+
    | storaged1 | 44500 | ONLINE | 1            | nba:5               | nba:5                  |
    +-----------+-------+--------+--------------+---------------------+------------------------+
    | storaged2 | 44500 | ONLINE | 1            | nba:5               | nba:5                  |
    +-----------+-------+--------+--------------+---------------------+------------------------+
    Got 3 rows (time spent 744/1123 us)
    ```

    If the **Leader distribution** is uneven, use `BALANCE LEADER` to redistribute the partitions. For more information, see [BALANCE](TODO) [TODO].

3. Use the `nba` graph space.

    ```nGQL
    (root@nebula) [(none)]> USE nba;
    Execution succeeded (time spent 1322/2206 us)
    ```

    You can use `SHOW SPACES` to check the graph space you created.

    ```nGQL
    (root@nebula) [nba]> SHOW SPACES;
    +------+
    | Name |
    +------+
    | nba  |
    +------+
    Got 1 rows (time spent 1235/1934 us)
    ```

## Create tags and edge types

### nGQL Syntax

```nGQL
CREATE {TAG | EDGE} {<tag name> | <edge type>}(<property name 1> <data type>, [<property name 2> <data type>, ...]);
```

### Demonstration

Create tags `player` and `team`, edge types `follow` and `serve`.

| Component name | Type      | Property                         |
| -------------- | --------- | -------------------------------- |  |
| player         | Tag       | name (string), age (int)         |
| team           | Tag       | name (string)                    |
| follow         | Edge type | degree (int)                     |
| serve          | Edge type | start_year (int), end_year (int) |

```nGQL
(root@nebula) [nba]> CREATE TAG player(name string, age int);
Execution succeeded (time spent 2694/3116 us)

Thu, 15 Oct 2020 06:22:29 UTC

(root@nebula) [nba]> CREATE TAG team(name string);
Execution succeeded (time spent 2630/3002 us)

Thu, 15 Oct 2020 06:22:37 UTC

(root@nebula) [nba]> CREATE EDGE follow(degree int);
Execution succeeded (time spent 3087/3467 us)

Thu, 15 Oct 2020 06:22:43 UTC

(root@nebula) [nba]> CREATE EDGE serve(start_year int, end_year int);
Execution succeeded (time spent 2645/3123 us)

Thu, 15 Oct 2020 06:22:50 UTC
```

## Create indexes

Nebula Graph supports two different kinds of indexing to speed up query processing: tag indexes and edge type indexes. Normally, an index is created at the time the tag or edge type is created. For more information, see [Nebula Graph indexes](TODO) [TODO].

> **CAUTION**: Creating indexes decreases the write performance.

Indexes do not affect the data created before them. For example, if you created a vertex with the tag `player` and property `name`, and the value of `name` was `Tom`. Then you created an index based on the property `name`, this index were not able to cover vertex `Tom`. At this time, you need to rebuild the index to make it take effect on pre-existing data. For more information, see [Rebuild indexes](TODO) [TODO].

### nGQL Syntax

`CREATE {TAG | EDGE} INDEX [IF NOT EXISTS] <index_name> ON {<tag_name> | <edge_name>} (prop_name_list)`

### Demonstration

Create an index for the `name` property on all vertices with the tag `player`.

```nGQL
CREATE TAG INDEX player_index_0 on player(name);
```

## Create vertices and edges

You can use the `INSERT` statement to create vertices or edges based on existing tags or edge types.

### nGQL Syntax

* Create vertices:

    ```nGQL
    INSERT VERTEX <tag> (<property name 1>[, <property name 2>...]) [, <tag> (<property name 3>[, <property name 4>...]), ...]  {VALUES | VALUE} "<VID>": (<property value 1>[, <property value2>...])
    ```

    `VID` is short for vertex ID. It's must be a unique int64 value in a graph space.

* Create edges:

    ```nGQL
    INSERT EDGE <edge type> (<property name 1>[, <property name 2>...]) {VALUES | VALUE} <src_vid> -> <dst_vid>[@<rank>] :  (<property value 1>[, <property value 2>...]) [, <src_vid> -> <dst_vid> : (<property name 1>[, <property name 2>...]), ...]
    ```

### Demonstration

* Create vertices representing NBA players and teams:

    ```nGQL
    (root@nebula) [nba]> INSERT VERTEX player(name, age) VALUES "100":("Tim Duncan", 42);
    Execution succeeded (time spent 2919/3485 us)

    Fri, 16 Oct 2020 03:41:00 UTC

    (root@nebula) [nba]> INSERT VERTEX player(name, age) VALUES "101":("Tony Parker", 36);
    Execution succeeded (time spent 3007/3539 us)

    Fri, 16 Oct 2020 03:41:58 UTC

    (root@nebula) [nba]> INSERT VERTEX player(name, age) VALUES "102":("LaMarcus Aldridge", 33);
    Execution succeeded (time spent 2449/2934 us)

    Fri, 16 Oct 2020 03:42:16 UTC

    (root@nebula) [nba]> (root@nebula) [nba]> INSERT VERTEX team(name) VALUES "200":("Warriors"), "201":("Nuggets");
    Execution succeeded (time spent 3514/4331 us)

    Fri, 16 Oct 2020 03:42:45 UTC

    (root@nebula) [nba]> INSERT VERTEX player(name, age) VALUES "121":("ToBeDeleted", 60);
    Execution succeeded (time spent 1428/2027 us)

    Fri, 16 Oct 2020 03:51:31 UTC
    ```

* Create edges representing the relations between NBA players and teams.

    [TODO]

## Read vertices and edges

TODO

## Update vertices and edges

TODO

## Delete vertices and edges

TODO

## What to do next

TODO
